<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripGoGo æ—…è¡Œè¨˜å¸³</title>
    <!-- App åœ–æ¨™è¨­å®š -->
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/201/201623.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        :root {
            --color-cream: #f8f5f1;
            --color-latte: #d2b48c;
            --color-mocha: #6f4e37;
            --color-text: #2c2c2c;
            --color-accent: #d97706; /* Amber-600 */
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--color-text);
            background-color: #fcece0;
        }

        #app {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            background-color: var(--color-cream);
            padding-bottom: 50px;
        }

        .horizontal-scroll-container::-webkit-scrollbar { display: none; }
        .horizontal-scroll-container { -ms-overflow-style: none; scrollbar-width: none; }

        .itinerary-card {
            border-left: 5px solid var(--color-latte);
            transition: all 0.2s;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background-color: var(--color-cream);
            width: 100%;
            max-width: 400px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .milk-tea-text { color: var(--color-mocha); }
        
        /* Login Form Styles */
        .login-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.3s;
            outline: none;
        }
        .login-input:focus {
            border-color: var(--color-accent);
            background-color: #fffbeb;
        }
    </style>
</head>
<body class="p-4 sm:p-6">

<div id="app">
    <main class="rounded-xl shadow-lg p-4 sm:p-6 min-h-[90vh] relative">
        
        <!-- Header -->
        <div class="mb-6 text-center relative">
            <h1 class="text-3xl font-extrabold milk-tea-text tracking-tight">
                âœˆï¸ {{ appTitle }}
            </h1>
            
            <!-- Admin Edit Button (Only visible if currentUser is Admin) -->
            <button v-if="currentUser && currentUser.isAdmin && tripExists" 
                @click="openEditSettings"
                class="absolute top-1 right-0 text-gray-400 hover:text-gray-600 p-2">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>

            <p v-if="currentUser" class="text-sm text-gray-500 mt-2 font-bold flex items-center justify-center gap-1">
                Hi, {{ currentUser.name }} 
                <span v-if="currentUser.isAdmin" class="bg-yellow-100 text-yellow-700 text-[10px] px-1 rounded border border-yellow-200">ç®¡ç†å“¡</span>
                <span v-else class="bg-gray-100 text-gray-600 text-[10px] px-1 rounded border border-gray-200">æˆå“¡</span>
                <button @click="logout" class="text-[10px] underline text-gray-400 ml-2 hover:text-gray-600">ç™»å‡º</button>
            </p>
        </div>

        <!-- 0. Loading -->
        <div v-if="isInitializing" class="text-center py-20 bg-white rounded-xl shadow-inner">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-600 mx-auto mb-4"></div>
            <p class="text-gray-600 font-bold animate-pulse">TripGoGoç‚ºæ‚¨åŠ è¼‰ä¸­ğŸ½</p>
        </div>
        
        <!-- 1. Universal Login Form -->
        <div v-if="!isInitializing && !currentUser" class="modal-overlay">
            <div class="modal-content">
                <div class="text-center mb-6">
                    <div class="bg-orange-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="plane" class="w-8 h-8 text-orange-600"></i>
                    </div>
                    <h2 class="text-2xl font-extrabold milk-tea-text">æ­¡è¿ä½¿ç”¨ TripGoGo</h2>
                    <p class="text-xs text-gray-500 mt-1">è¼¸å…¥ç›¸åŒçš„ã€Œç¾¤çµ„ä»£ç¢¼ã€å³å¯èˆ‡æœ‹å‹å…±äº«è¡Œç¨‹</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-1 text-gray-700">ç¾¤çµ„ä»£ç¢¼ (Group ID)</label>
                        <div class="relative">
                            <i data-lucide="users" class="absolute left-3 top-3 w-5 h-5 text-gray-400"></i>
                            <input type="text" v-model="loginForm.groupId" class="login-input pl-10" placeholder="ä¾‹å¦‚: Tokyo2024" />
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-1 text-gray-700">æ‚¨çš„æš±ç¨±</label>
                        <div class="relative">
                            <i data-lucide="user" class="absolute left-3 top-3 w-5 h-5 text-gray-400"></i>
                            <input type="text" v-model="loginForm.name" class="login-input pl-10" placeholder="ä¾‹å¦‚: å°æ˜" />
                        </div>
                    </div>

                    <!-- Role Selection -->
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                        <span class="block text-xs font-bold text-gray-500 mb-2">é¸æ“‡èº«åˆ†</span>
                        <div class="flex gap-2">
                            <button @click="loginForm.isAdmin = false" 
                                :class="['flex-1 py-2 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-1', !loginForm.isAdmin ? 'bg-white border-2 border-gray-400 text-gray-700 shadow-sm' : 'text-gray-400 hover:bg-gray-100']">
                                æˆå“¡
                            </button>
                            <button @click="loginForm.isAdmin = true"
                                :class="['flex-1 py-2 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-1', loginForm.isAdmin ? 'bg-white border-2 border-orange-500 text-orange-700 shadow-sm' : 'text-gray-400 hover:bg-gray-100']">
                                <i data-lucide="shield" class="w-3 h-3"></i> ç®¡ç†å“¡
                            </button>
                        </div>
                    </div>
                </div>

                <button @click="handleLogin" :disabled="!isLoginValid" 
                    :class="['w-full mt-6 py-3 font-bold rounded-lg text-white shadow-md transition-transform active:scale-95', isLoginValid ? 'bg-orange-600 hover:bg-orange-700' : 'bg-gray-300 cursor-not-allowed']">
                    é€²å…¥æ—…ç¨‹
                </button>
            </div>
        </div>

        <!-- 2. Create Trip (Only for Admin if trip doesn't exist) -->
        <div v-if="!isInitializing && currentUser && !tripExists" class="modal-overlay">
            <div class="modal-content">
                <div v-if="currentUser.isAdmin">
                    <h2 class="text-2xl font-extrabold text-center milk-tea-text mb-4">å»ºç«‹æ–°è¡Œç¨‹</h2>
                    <p class="text-xs text-gray-500 text-center mb-4">ç¾¤çµ„ã€Œ{{ currentUser.groupId }}ã€å°šç„¡è³‡æ–™ã€‚<br>èº«ç‚ºç®¡ç†å“¡ï¼Œè«‹è¨­å®šæ—…éŠåœ°é»ã€‚</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold mb-1">App æ¨™é¡Œ</label>
                            <input type="text" v-model="wizard.appNameInput" class="w-full p-3 border rounded-lg" placeholder="ä¾‹å¦‚: å¤§é˜ªçˆ†è²·åœ˜" />
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">ç›®çš„åœ°</label>
                            <input type="text" v-model="wizard.destinationInput" class="w-full p-3 border rounded-lg" placeholder="ä¾‹: å¤§é˜ª" />
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">åŒ¯ç‡ ({{ detectedSettings.currency }} å°å°å¹£)</label>
                            <input type="number" v-model.number="wizard.rateInput" step="0.001" class="w-full p-3 border rounded-lg" />
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">æ—¥æœŸ</label>
                            <div class="flex gap-2">
                                <input type="date" v-model="wizard.startDateInput" class="w-full p-3 border rounded-lg" />
                                <input type="date" v-model="wizard.endDateInput" class="w-full p-3 border rounded-lg" />
                            </div>
                        </div>
                    </div>
                    <button @click="createTrip" :disabled="!isWizardValid" :class="['w-full mt-6 py-3 font-bold rounded-lg text-white', isWizardValid ? 'bg-orange-600' : 'bg-gray-300']">å»ºç«‹è¡Œç¨‹</button>
                </div>
                <div v-else class="text-center">
                    <h2 class="text-xl font-bold mb-2">ç­‰å¾…è¡Œç¨‹å»ºç«‹</h2>
                    <div class="text-6xl mb-4">â³</div>
                    <p class="text-gray-500 text-sm">æ­¤ç¾¤çµ„å°šæœªå»ºç«‹è¡Œç¨‹ã€‚</p>
                    <p class="text-gray-500 text-sm mt-2">è«‹è¯çµ¡æ‚¨çš„<b>ç®¡ç†å“¡</b>ä¾†è¨­å®šè¡Œç¨‹ã€‚</p>
                    <button @click="logout" class="mt-6 text-orange-600 underline text-sm">è¿”å›ç™»å…¥</button>
                </div>
            </div>
        </div>

        <!-- 2.5 Edit Trip Settings Modal -->
        <div v-if="isEditingSettings" class="modal-overlay">
            <div class="modal-content">
                <h2 class="text-2xl font-extrabold text-center milk-tea-text mb-4">ä¿®æ”¹è¡Œç¨‹è¨­å®š</h2>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-bold mb-1">App æ¨™é¡Œ</label>
                        <input type="text" v-model="editWizard.appName" class="w-full p-3 border rounded-lg" />
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">ç›®çš„åœ°</label>
                        <input type="text" v-model="editWizard.destination" class="w-full p-3 border rounded-lg" />
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">åŒ¯ç‡</label>
                        <input type="number" v-model.number="editWizard.rateTWD" step="0.001" class="w-full p-3 border rounded-lg" />
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">æ—¥æœŸç¯„åœ</label>
                        <div class="flex gap-2">
                            <input type="date" v-model="editWizard.startDate" class="w-full p-3 border rounded-lg" />
                            <input type="date" v-model="editWizard.endDate" class="w-full p-3 border rounded-lg" />
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button @click="isEditingSettings = false" class="flex-1 py-3 font-bold rounded-lg bg-gray-200 text-gray-700">å–æ¶ˆ</button>
                    <button @click="saveTripSettings" class="flex-1 py-3 font-bold rounded-lg bg-green-600 text-white">å„²å­˜ä¿®æ”¹</button>
                </div>
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <p class="text-xs text-red-600 font-bold mb-2 flex items-center">
                        <i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i> å±éšªå€åŸŸ
                    </p>
                    <button @click="resetTrip" :disabled="isResetting" class="w-full py-3 text-red-600 border border-red-200 rounded-lg hover:bg-red-50 text-sm font-bold transition-colors">
                        {{ isResetting ? 'æ­£åœ¨åˆªé™¤...' : 'è§£æ•£ç¾¤çµ„ (åˆªé™¤æ‰€æœ‰è³‡æ–™)' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- 3. Wallet Setup -->
        <div v-if="!isInitializing && currentUser && tripExists && !walletSetupComplete" class="modal-overlay">
            <div class="modal-content">
                <div class="text-center mb-4">
                    <h2 class="text-2xl font-extrabold milk-tea-text">è¨­å®š {{ currentUser.name }} çš„éŒ¢åŒ…</h2>
                </div>
                <p class="text-xs text-gray-500 text-center mb-4">é€™æ˜¯æ‚¨å€‹äººçš„ç§æˆ¿éŒ¢ï¼Œ<br>è«‹è¼¸å…¥æ‚¨é€™æ¬¡å¸¶äº†å¤šå°‘å°å¹£ã€‚</p>
                <div class="space-y-4 pt-4 border-t border-gray-200">
                    <div>
                        <label class="block text-sm font-bold mb-1">åˆå§‹å°å¹£è³‡é‡‘</label>
                        <input type="number" v-model.number="joiner.initialTWD" class="w-full p-3 border rounded-lg text-right font-mono text-lg" />
                    </div>
                    <div class="bg-gray-100 p-3 rounded-lg flex justify-between items-center">
                        <span class="text-sm text-gray-600">ç´„åˆ {{ tripSettings.currency }}</span>
                        <span class="font-bold text-lg">{{ joinerForeignCalculated.toLocaleString('en-US', { maximumFractionDigits: 0 }) }}</span>
                    </div>
                </div>
                <button @click="setupMyWallet" class="w-full mt-6 py-3 font-bold rounded-lg bg-orange-600 text-white">é–‹å•Ÿæˆ‘çš„éŒ¢åŒ…</button>
            </div>
        </div>

        <!-- 4. Main Interface -->
        <div v-else-if="!isInitializing && currentUser && tripExists && walletSetupComplete">
            
            <!-- Wallet Summary (Always Global) -->
            <section class="p-4 bg-white rounded-xl shadow-lg mb-6 border border-gray-100 relative overflow-hidden">
                <div class="absolute top-0 right-0 bg-orange-600 text-white text-[10px] px-2 py-1 rounded-bl-lg font-bold">Private</div>
                <h3 class="text-lg font-extrabold flex items-center milk-tea-text mb-2">
                    <i data-lucide="wallet" class="w-5 h-5 mr-2"></i>
                    {{ currentUser.name }} çš„é¤˜é¡
                </h3>
                <div class="flex flex-col space-y-1">
                    <div class="flex justify-between items-center text-base">
                        <span class="font-extrabold">{{ tripSettings.currency }} (ä¼°):</span> 
                        <span class="font-mono text-xl text-green-600 font-extrabold">{{ wallet.currentForeign.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) }}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm border-t border-gray-100 pt-1">
                        <span class="text-gray-600">å°å¹£ (TWD):</span> 
                        <span class="font-mono text-base ml-1 text-gray-700">{{ wallet.currentTWD.toLocaleString('zh-TW', { minimumFractionDigits: 0 }) }}</span>
                    </div>
                </div>
            </section>
            
            <!-- Tabs -->
            <div class="flex justify-center mb-6 space-x-2">
                <button @click="activeTab = 'itinerary'" :class="['flex-1 py-2 rounded-xl font-bold border transition-colors', activeTab === 'itinerary' ? 'bg-orange-600 text-white' : 'bg-gray-100 text-gray-600']">å…±ç”¨è¡Œç¨‹</button>
                <button @click="activeTab = 'wallet'" :class="['flex-1 py-2 rounded-xl font-bold border transition-colors', activeTab === 'wallet' ? 'bg-orange-600 text-white' : 'bg-gray-100 text-gray-600']">è¨˜å¸³</button>
            </div>

            <!-- Date Selection (Controls both Itinerary and Wallet Filter) -->
            <section class="mb-6">
                <h3 class="text-xl font-bold mb-3">æ—¥æœŸ ({{ selectedDateDisplay }})</h3>
                <div class="flex space-x-3 pb-3 horizontal-scroll-container overflow-x-scroll">
                    <template v-for="(date, index) in tripDays" :key="date.iso">
                        <button @click="selectedDate = date.iso" :class="['py-2 px-4 rounded-full font-bold flex-shrink-0 shadow-md', selectedDate === date.iso ? 'bg-orange-600 text-white' : 'bg-white text-gray-600']">
                            {{ date.display }}
                        </button>
                    </template>
                </div>
            </section>
            
            <!-- Itinerary Tab -->
            <div v-if="activeTab === 'itinerary'">
                <div v-if="itinerary[selectedDate]?.length === 0" class="text-center py-10 bg-white rounded-xl text-gray-500 border border-dashed border-gray-300">
                    <p>æœ¬æ—¥å°šç„¡è¡Œç¨‹</p>
                </div>
                <div class="space-y-4">
                    <div v-for="(item, index) in itinerary[selectedDate]" 
                         :key="index" 
                         @click="focusMap(item.location)"
                         class="itinerary-card p-4 bg-white rounded-xl shadow-sm border border-gray-100 cursor-pointer hover:bg-orange-50 relative group">
                        
                        <div class="absolute right-2 top-2 text-[10px] text-gray-300 group-hover:text-orange-600 transition-colors">
                            <i data-lucide="map-pin" class="w-3 h-3 inline"></i> é»æ“Šçœ‹åœ°åœ–
                        </div>

                        <div v-if="!item.isEditing" class="flex justify-between items-start">
                            <div class="flex-grow">
                                <p class="text-lg font-extrabold milk-tea-text">{{ item.time }} - {{ item.location }}</p>
                                <p class="text-sm text-gray-500">{{ item.notes }}</p>
                            </div>
                            <div class="flex flex-col space-y-2 ml-4" @click.stop>
                                <button v-if="currentUser.isAdmin || true" @click="editItem(selectedDate, index)" class="p-2 bg-gray-100 rounded-full flex items-center justify-center text-gray-600"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button v-if="currentUser.isAdmin" @click="deleteItem(selectedDate, index)" class="p-2 bg-red-100 rounded-full flex items-center justify-center text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div v-else class="space-y-2" @click.stop>
                            <input v-model="item.time" type="time" class="w-full p-2 border rounded" />
                            <input v-model="item.location" class="w-full p-2 border rounded" placeholder="åœ°é»" />
                            <input v-model="item.notes" class="w-full p-2 border rounded" placeholder="å‚™è¨»" />
                            <button @click="saveItem(selectedDate, index)" class="w-full py-2 bg-orange-600 text-white rounded font-bold">å„²å­˜</button>
                        </div>
                    </div>
                </div>
                <!-- Allow anyone to add items, or just admin? Let's allow anyone for convenience, or stick to admin -->
                <button @click="addNewItem(selectedDate)" class="w-full mt-4 py-3 bg-gray-800 text-white font-bold rounded-lg shadow-md flex items-center justify-center">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i> æ–°å¢è¡Œç¨‹
                </button>
                <section class="mt-8">
                     <div v-if="mapUrl" class="rounded-lg overflow-hidden border border-gray-200 shadow-lg relative">
                        <div v-if="selectedLocation" class="absolute top-0 left-0 bg-orange-600 text-white text-xs px-2 py-1 z-10 rounded-br">
                            ğŸ“ æ­£åœ¨æª¢è¦–: {{ selectedLocation }}
                        </div>
                        <iframe :src="mapUrl" width="100%" height="250" style="border:0;" loading="lazy"></iframe>
                    </div>
                </section>
            </div>
            
            <!-- Wallet Tab -->
            <div v-if="activeTab === 'wallet'">
                <!-- Currency Converter -->
                <div class="p-4 bg-orange-100 rounded-xl shadow-md mb-6 border border-orange-200">
                    <h4 class="font-extrabold text-lg mb-3 milk-tea-text flex items-center">
                        <i data-lucide="calculator" class="w-5 h-5 mr-2"></i> åŒ¯ç‡æ›ç®—å°å¹«æ‰‹
                    </h4>
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">åŒ¯ç‡ ({{ tripSettings.currency }} â†’ TWD)</label>
                            <input type="number" v-model.number="converter.rate" step="0.001" class="w-full p-2 border border-orange-200 rounded-lg text-sm" />
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">è¼¸å…¥ {{ tripSettings.currency }}</label>
                            <input type="number" v-model.number="converter.amount" placeholder="é‡‘é¡" class="w-full p-2 border border-orange-200 rounded-lg text-sm text-right bg-white" />
                        </div>
                    </div>
                    <div class="flex justify-between items-center bg-white p-2 rounded-lg border border-orange-100">
                        <span class="text-sm font-bold text-gray-500">æ›ç®—çµæœ (TWD)</span>
                        <span class="text-xl font-extrabold text-orange-600">{{ converterResult.toLocaleString() }}</span>
                    </div>
                </div>

                <div class="p-4 bg-white rounded-xl shadow-lg mb-6">
                    <h4 class="font-extrabold text-lg mb-3 milk-tea-text">æ–°å¢äº¤æ˜“ ({{ selectedDateDisplay }})</h4>
                    <div class="space-y-3">
                        <div class="flex space-x-2">
                            <input type="date" v-model="newTransaction.date" class="w-3/5 p-2 border rounded-lg text-sm bg-gray-50" />
                            <input type="time" v-model="newTransaction.time" class="w-2/5 p-2 border rounded-lg text-sm bg-gray-50" />
                        </div>
                        
                        <div class="flex space-x-2">
                            <select v-model="newTransaction.type" class="w-1/3 p-2 border rounded-lg text-sm bg-gray-50">
                                <option value="expense">æ”¯å‡º</option>
                                <option value="topup">å…¥å¸³</option>
                            </select>
                            <select v-model="newTransaction.currency" class="w-1/3 p-2 border rounded-lg text-sm bg-gray-50">
                                <option :value="tripSettings.currency">{{ tripSettings.currency }}</option>
                                <option value="TWD">TWD</option>
                            </select>
                            <input type="number" v-model.number="newTransaction.amount" placeholder="é‡‘é¡" class="w-1/3 p-2 border rounded-lg text-right font-mono" />
                        </div>
                        <input type="text" v-model="newTransaction.notes" placeholder="é …ç›®åç¨±" class="w-full p-2 border rounded-lg" />
                        <button @click="addTransaction" :disabled="!isTransactionValid" :class="['w-full py-2 font-bold rounded-lg', isTransactionValid ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-500']">
                            ç´€éŒ„
                        </button>
                    </div>
                </div>

                <div class="space-y-3">
                    <div v-if="filteredTransactions.length === 0" class="text-center py-6 text-gray-400 text-sm">
                        æœ¬æ—¥ç„¡äº¤æ˜“ç´€éŒ„
                    </div>
                    <div v-for="tx in filteredTransactions" :key="tx.id" class="p-3 bg-white rounded-xl shadow-sm border border-gray-100">
                        <div v-if="editingTxId === tx.id" class="space-y-2">
                             <div class="flex space-x-2">
                                <input type="date" v-model="editingTransaction.date" class="w-1/2 p-2 border rounded text-sm" />
                                <input type="time" v-model="editingTransaction.time" class="w-1/2 p-2 border rounded text-sm" />
                            </div>
                            <div class="flex space-x-2">
                                <select v-model="editingTransaction.type" class="w-1/3 p-2 border rounded text-sm">
                                    <option value="expense">æ”¯å‡º</option>
                                    <option value="topup">å…¥å¸³</option>
                                </select>
                                <select v-model="editingTransaction.currency" class="w-1/3 p-2 border rounded text-sm">
                                    <option :value="tripSettings.currency">{{ tripSettings.currency }}</option>
                                    <option value="TWD">TWD</option>
                                </select>
                                <input type="number" v-model.number="editingTransaction.amount" class="w-1/3 p-2 border rounded text-right" />
                            </div>
                            <input type="text" v-model="editingTransaction.notes" class="w-full p-2 border rounded" />
                            <div class="flex space-x-2">
                                <button @click="saveTransactionEdit" class="flex-1 py-2 bg-green-600 text-white rounded text-sm font-bold">ç¢ºèª</button>
                                <button @click="cancelTransactionEdit" class="flex-1 py-2 bg-gray-400 text-white rounded text-sm">å–æ¶ˆ</button>
                            </div>
                        </div>

                        <div v-else class="flex justify-between items-center">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-mono text-xs text-gray-400 bg-gray-100 px-1 rounded">{{ tx.time || '--:--' }}</span>
                                    <p class="font-bold text-sm">{{ tx.notes }}</p>
                                </div>
                                <p class="text-xs text-gray-500 pl-1">{{ tx.type === 'expense' ? 'æ”¯å‡º' : 'å…¥å¸³' }} ({{ tx.currency }})</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span :class="['font-extrabold mr-2', tx.type === 'expense' ? 'text-red-600' : 'text-green-600']">
                                    {{ tx.type === 'expense' ? '-' : '+' }}{{ tx.amount.toLocaleString() }}
                                </span>
                                <button @click="editTransaction(tx)" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 text-gray-600 flex items-center justify-center">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                <button @click="deleteTransaction(tx.id)" class="p-2 bg-red-50 rounded-full hover:bg-red-100 text-red-500 flex items-center justify-center">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script type="module">
   // Firebase Config
   const userConfig = {
      apiKey: "AIzaSyCrNe8ZxZCofC5mxlmkXJ-Jjr5bA19_B4I",
      authDomain: "trip-app-2026.firebaseapp.com",
      projectId: "trip-app-2026",
      storageBucket: "trip-app-2026.firebasestorage.app",
      messagingSenderId: "92743336008",
      appId: "1:92743336008:web:7e5da82d9b10cd8f67587d",
      measurementId: "G-DDSMLPDLJP"
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const firebaseConfig = envConfig || userConfig;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, deleteDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    const { ref, computed, watch, onMounted, nextTick } = Vue;
    const generateId = () => Math.random().toString(36).substring(2, 9);
    
    const DESTINATION_SETTINGS = {
        'tokyo': { currency: 'JPY', name: 'æ±äº¬' },
        'osaka': { currency: 'JPY', name: 'å¤§é˜ª' },
        'seoul': { currency: 'KRW', name: 'é¦–çˆ¾' },
        'default': { currency: 'CUR', name: 'æ—…éŠ' }
    };
    const getSettings = (destInput) => {
        if (!destInput) return DESTINATION_SETTINGS['default'];
        const lower = destInput.toLowerCase();
        if (lower.includes('æ±äº¬') || lower.includes('tokyo')) return DESTINATION_SETTINGS['tokyo'];
        if (lower.includes('å¤§é˜ª') || lower.includes('osaka')) return DESTINATION_SETTINGS['osaka'];
        if (lower.includes('é¦–çˆ¾') || lower.includes('korea')) return DESTINATION_SETTINGS['seoul'];
        return DESTINATION_SETTINGS['default'];
    };

    const App = {
        setup() {
            // -- State --
            const isInitializing = ref(true); 
            const isResetting = ref(false);
            const db = ref(null);
            
            // Login & User State
            const loginForm = ref({ groupId: '', name: '', isAdmin: false });
            const currentUser = ref(null);
            const isLoginValid = computed(() => loginForm.value.groupId.trim().length > 1 && loginForm.value.name.trim().length > 0);

            // Firestore References
            const tripSharedRef = ref(null);
            const currentWalletRef = ref(null);
            
            // Listeners
            let tripUnsubscribe = null;
            let walletUnsubscribe = null;

            // App State
            const activeTab = ref('itinerary'); 
            const tripExists = ref(false);
            const walletSetupComplete = ref(false);

            const wizard = ref({ appNameInput: 'æˆ‘çš„æ—…ç¨‹', destinationInput: '', rateInput: 0.22, startDateInput: '', endDateInput: '' });
            const joiner = ref({ initialTWD: 20000 });
            
            const isEditingSettings = ref(false);
            const editWizard = ref({});

            const newTransaction = ref({ type: 'expense', currency: 'JPY', amount: '', notes: '', date: '', time: '' });
            const editingTxId = ref(null);
            const editingTransaction = ref({});
            
            const converter = ref({ rate: 0.22, amount: '' });

            const tripSettings = ref({ appName: 'æˆ‘çš„æ—…ç¨‹', destination: '', startDate: '', endDate: '', currency: 'JPY', rateTWD: 0.22 });
            const itinerary = ref({}); 
            const wallet = ref({ initialTWD: 0, initialForeign: 0, currentTWD: 0, currentForeign: 0 }); 
            const transactions = ref([]); 

            // -- Computed --
            const appTitle = computed(() => tripSettings.value.appName);
            const detectedSettings = computed(() => getSettings(wizard.value.destinationInput));
            const joinerForeignCalculated = computed(() => (joiner.value.initialTWD / (tripSettings.value.rateTWD || 1)) || 0);
            const isWizardValid = computed(() => wizard.value.destinationInput && wizard.value.startDateInput && wizard.value.endDateInput);
            const isTransactionValid = computed(() => newTransaction.value.amount > 0 && newTransaction.value.notes && newTransaction.value.date);

            const converterResult = computed(() => {
                if (!converter.value.amount || !converter.value.rate) return 0;
                return Math.round(converter.value.amount * converter.value.rate);
            });

            const tripDays = computed(() => {
                if(!tripSettings.value.startDate || !tripSettings.value.endDate) return [];
                const dates = [];
                let curr = new Date(tripSettings.value.startDate);
                const end = new Date(tripSettings.value.endDate);
                while (curr <= end) {
                    const mm = String(curr.getMonth() + 1).padStart(2, '0');
                    const dd = String(curr.getDate()).padStart(2, '0');
                    const dw = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][curr.getDay()];
                    dates.push({ iso: curr.toISOString().split('T')[0], display: `${mm}/${dd} (${dw})` });
                    curr.setDate(curr.getDate() + 1);
                }
                return dates;
            });
            
            const selectedDate = ref('');
            const selectedLocation = ref('');
            const selectedDateDisplay = computed(() => tripDays.value.find(d => d.iso === selectedDate.value)?.display || '');

            const mapUrl = computed(() => {
                if (selectedLocation.value) {
                    return `https://maps.google.com/maps?q=${encodeURIComponent(selectedLocation.value)}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
                }
                const items = itinerary.value[selectedDate.value] || [];
                const locs = items.map(i => i.location).filter(l => l).join(' ');
                const q = locs || tripSettings.value.destination;
                return q ? `https://maps.google.com/maps?q=${encodeURIComponent(q)}&t=&z=10&ie=UTF8&iwloc=&output=embed` : '';
            });
            
            const filteredTransactions = computed(() => {
                return transactions.value
                    .filter(tx => tx.date === selectedDate.value)
                    .sort((a, b) => {
                        const tA = a.time || '00:00';
                        const tB = b.time || '00:00';
                        return tB.localeCompare(tA);
                    });
            }); 

            // -- Watchers --
            watch(() => tripSettings.value.rateTWD, (newRate) => {
                if (newRate) converter.value.rate = newRate;
            });
            
            watch(tripDays, (v) => { 
                if(v.length && !selectedDate.value) {
                    selectedDate.value = v[0].iso;
                }
            });
            
            watch(selectedDate, (newVal) => {
                selectedLocation.value = '';
                if (newVal) {
                    newTransaction.value.date = newVal;
                    const now = new Date();
                    const hh = String(now.getHours()).padStart(2, '0');
                    const mm = String(now.getMinutes()).padStart(2, '0');
                    newTransaction.value.time = `${hh}:${mm}`;
                }
            });

            // -- Core Functions --
            
            const recalculateWallet = () => {
                const rate = parseFloat(tripSettings.value.rateTWD) || 0.22;
                let totalTWD = parseFloat(wallet.value.initialTWD) || 0;
                transactions.value.forEach(tx => {
                    let costInTWD = tx.currency === 'TWD' ? tx.amount : (tx.amount * rate);
                    if (tx.type === 'expense') totalTWD -= costInTWD;
                    else totalTWD += costInTWD;
                });
                wallet.value.currentTWD = Math.round(totalTWD);
                wallet.value.currentForeign = Math.round(totalTWD / rate); 
            };

            // Login Logic
            const handleLogin = () => {
                if(!isLoginValid.value) return;
                // Save to session/local storage if needed, here we just set state
                currentUser.value = {
                    groupId: loginForm.value.groupId.trim(),
                    name: loginForm.value.name.trim(),
                    isAdmin: loginForm.value.isAdmin
                };
                connectToFirestore();
            };

            const logout = () => {
                if (tripUnsubscribe) tripUnsubscribe();
                if (walletUnsubscribe) walletUnsubscribe();
                currentUser.value = null;
                tripExists.value = false;
                walletSetupComplete.value = false;
                loginForm.value = { groupId: '', name: '', isAdmin: false };
            };

            const connectToFirestore = () => {
                // RULE 1: Strict paths.
                // Trip Data: artifacts/{appId}/public/data/universal_trips/{groupId}
                // Wallet Data: artifacts/{appId}/public/data/universal_wallets/{groupId}_{userName}
                
                const gid = currentUser.value.groupId;
                const uname = currentUser.value.name;
                
                // 1. Listen to Trip Data
                tripSharedRef.value = doc(db.value, 'artifacts', appId, 'public', 'data', 'universal_trips', gid);
                tripUnsubscribe = onSnapshot(tripSharedRef.value, (snap) => {
                    const d = snap.data();
                    if (!snap.exists() || d?.status === 'RESET') {
                        tripExists.value = false;
                        itinerary.value = {};
                        // Reset settings to default for wizard
                        wizard.value = { appNameInput: 'æˆ‘çš„æ—…ç¨‹', destinationInput: '', rateInput: 0.22, startDateInput: '', endDateInput: '' };
                    } else {
                        tripSettings.value = d.tripSettings || tripSettings.value;
                        itinerary.value = d.itinerary || {};
                        tripExists.value = true;
                        if (tripSettings.value.rateTWD) converter.value.rate = tripSettings.value.rateTWD;
                    }
                    nextTick(() => typeof lucide !== 'undefined' && lucide.createIcons());
                });

                // 2. Listen to My Wallet
                const walletDocId = `${gid}_${uname}`;
                currentWalletRef.value = doc(db.value, 'artifacts', appId, 'public', 'data', 'universal_wallets', walletDocId);
                walletUnsubscribe = onSnapshot(currentWalletRef.value, (snap) => {
                    if (snap.exists()) {
                        const d = snap.data();
                        wallet.value = d.wallet;
                        transactions.value = d.transactions || [];
                        walletSetupComplete.value = true;
                        recalculateWallet();
                    } else {
                        walletSetupComplete.value = false;
                        wallet.value = { initialTWD: 0 };
                        transactions.value = [];
                    }
                });
            };

            const createTrip = async () => {
                const s = detectedSettings.value;
                const newSettings = { 
                    appName: wizard.value.appNameInput, 
                    destination: s.name || wizard.value.destinationInput, 
                    startDate: wizard.value.startDateInput, 
                    endDate: wizard.value.endDateInput, 
                    currency: s.currency, 
                    rateTWD: parseFloat(wizard.value.rateInput) 
                };
                await setDoc(tripSharedRef.value, { tripSettings: newSettings, itinerary: {}, status: 'ACTIVE', createdBy: currentUser.value.name });
            };

            const setupMyWallet = async () => {
                const twd = parseFloat(joiner.value.initialTWD);
                const rate = tripSettings.value.rateTWD;
                const newWallet = { initialTWD: twd, initialForeign: twd/rate, currentTWD: twd, currentForeign: twd/rate };
                await setDoc(currentWalletRef.value, { wallet: newWallet, transactions: [] });
            };

            // Shared Trip Operations
            const saveShared = async () => setDoc(tripSharedRef.value, { itinerary: itinerary.value }, { merge: true });
            
            const addNewItem = async (date) => {
                if (!itinerary.value[date]) itinerary.value[date] = [];
                itinerary.value[date].push({ id: generateId(), time: '10:00', location: '', notes: '', isEditing: true });
                await saveShared();
            };
            const saveItem = (d, i) => { itinerary.value[d][i].isEditing = false; saveShared(); };
            const editItem = (d, i) => { itinerary.value[d][i].isEditing = true; };
            const deleteItem = (d, i) => { itinerary.value[d].splice(i, 1); saveShared(); };

            // Wallet Operations
            const saveWallet = async () => setDoc(currentWalletRef.value, { wallet: wallet.value, transactions: transactions.value });
            
            const addTransaction = async () => {
                transactions.value.push({ ...newTransaction.value, id: generateId() });
                recalculateWallet(); await saveWallet();
                newTransaction.value.amount = ''; 
                newTransaction.value.notes = '';
                const now = new Date();
                newTransaction.value.time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            };
            const deleteTransaction = async (id) => {
                transactions.value = transactions.value.filter(t => t.id !== id);
                recalculateWallet(); await saveWallet();
            };
            const editTransaction = (tx) => { editingTransaction.value = JSON.parse(JSON.stringify(tx)); editingTxId.value = tx.id; };
            const cancelTransactionEdit = () => { editingTxId.value = null; editingTransaction.value = {}; };
            const saveTransactionEdit = async () => {
                const idx = transactions.value.findIndex(t => t.id === editingTxId.value);
                if (idx !== -1) { transactions.value[idx] = { ...editingTransaction.value }; recalculateWallet(); await saveWallet(); }
                cancelTransactionEdit();
            };

            // Admin Settings
            const openEditSettings = () => {
                editWizard.value = JSON.parse(JSON.stringify(tripSettings.value));
                isEditingSettings.value = true;
            };
            const saveTripSettings = async () => {
                const updatedSettings = { ...editWizard.value };
                await setDoc(tripSharedRef.value, { tripSettings: updatedSettings }, { merge: true });
                isEditingSettings.value = false;
                alert("è¨­å®šå·²æ›´æ–°ï¼");
            };

            const resetTrip = async () => {
                if (confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒåˆªé™¤æ‰€æœ‰äººçš„è¡Œç¨‹è³‡æ–™ï¼(éŒ¢åŒ…è³‡æ–™å°‡æœƒä¿ç•™ä½†è®Šç‚ºå­¤å…’è³‡æ–™)ã€‚ç¢ºå®šå—ï¼Ÿ")) {
                    try {
                        isResetting.value = true;
                        // For universal app, we just delete the trip doc. 
                        // Users' wallets are separate docs, we can't delete them all easily without a list, 
                        // but deleting the trip doc effectively "hides" the trip.
                        await deleteDoc(tripSharedRef.value);
                        
                        isEditingSettings.value = false;
                        tripExists.value = false;
                        alert("å·²è§£æ•£ç¾¤çµ„ã€‚");
                    } catch (e) { 
                        console.error("Reset failed", e); 
                        alert("é‡è¨­å¤±æ•—: " + e.message); 
                    } finally { 
                        isResetting.value = false; 
                    }
                }
            };

            const focusMap = (loc) => { if (loc) selectedLocation.value = loc; };
            const renderIcons = () => nextTick(() => typeof lucide !== 'undefined' && lucide.createIcons());
            
            watch([itinerary, transactions, activeTab, editingTxId, isEditingSettings, selectedLocation, selectedDate, currentUser], renderIcons, { deep: true });

            onMounted(async () => { 
                // Initialize Firebase
                if (!firebaseConfig) return;
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db.value = getFirestore(app);
                try { 
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken); 
                    else await signInAnonymously(auth); 
                } catch {}
                isInitializing.value = false; 
            });

            return {
                isInitializing, isResetting, 
                loginForm, currentUser, isLoginValid, handleLogin, logout,
                tripExists, walletSetupComplete, wizard, detectedSettings, isWizardValid, createTrip,
                joiner, joinerForeignCalculated, setupMyWallet,
                tripSettings, appTitle, itinerary, selectedDate, selectedDateDisplay, tripDays, mapUrl, activeTab,
                wallet, newTransaction, isTransactionValid, filteredTransactions,
                addNewItem, saveItem, editItem, deleteItem,
                addTransaction, deleteTransaction, 
                editingTxId, editingTransaction, editTransaction, cancelTransactionEdit, saveTransactionEdit,
                resetTrip,
                isEditingSettings, editWizard, openEditSettings, saveTripSettings,
                selectedLocation, focusMap,
                converter, converterResult
            };
        }
    };
    Vue.createApp(App).mount('#app');
</script>

</body>
</html>

